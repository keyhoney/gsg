---
alwaysApply: true
---
#0단계 Cloudflare Page로 배포 전환
1. 아래 전체 내용에 알맞게 프로젝트 전체 구조를 전환
2. 구조 전환 이후 불필요한 파일 삭제

# 1단계 해설 플랫폼의 핵심 인증 시스템을 구현

## 이 시스템은 이메일 기반 OTP 인증과 교재 소유권 증명 챌린지를 통해 사용자를 인증하고, 콘텐츠 접근 권한을 관리합니다. Cloudflare 생태계(D1, KV, Pages Functions)와 Lucia Auth를 활용하여 안전하고 확장 가능한 인증 시스템을 구축합니다.

## 요구사항
### 요구사항 1 : 교재를 구매한 사용자로서, 이메일 주소만으로 간편하게 계정을 생성하고 로그인할 수 있어야 하며, 별도의 비밀번호 설정 없이도 안전하게 인증받을 수 있어야 합니다.
#### 승인 기준
1. 사용자가 이메일 주소를 입력하고 OTP 요청을 하면 시스템은 해당 이메일로 6자리 숫자 OTP를 발송
2. 발송된 OTP가 5분 이내에 입력되면 시스템은 OTP를 검증하고 세션을 생성
3. 해당 이메일로 가입된 계정이 없으면 시스템은 자동으로 새 계정을 생성
4. OTP 검증이 성공하면 시스템은 Lucia Auth를 통해 안전한 세션 쿠키를 설정
5. OTP가 만료되거나 잘못된 경우 시스템은 적절한 오류 메시지를 표시
#### 데이터 플로우
**OTP 인증 플로우**
   - 사용자 이메일 입력 → Turnstile 검증 → OTP 생성 → KV 저장 → 이메일 발송
   - OTP 입력 → KV 검증 → 사용자 생성/조회 → Lucia 세션 생
  
### 요구사항 2 : 교재 소유자로서, 실물 책의 특정 페이지와 줄의 단어를 확인하여 교재 소유권을 증명할 수 있어야 하며, 이를 통해 해당 교재의 해설에 대한 영구적인 접근 권한을 얻을 수 있어야 합니다.

#### 승인 기준
1. 로그인한 사용자가 특정 교재에 대한 구매 인증을 요청하면 시스템은 해당 교재의 3개 랜덤 질문을 제시
2.사용자가 3개 질문에 답변을 제출하면 시스템은 정답을 검증
3. 3개 중 2개 이상 정답이면 시스템은 해당 사용자에게 해당 교재 접근 권한을 부여
4. 권한이 부여되면 시스템은 Entitlements 테이블에 3개월 간 기록
5. 정답이 2개 미만이면 시스템은 구매 인증 실패를 알리고 재시도를 허용
#### 데이터 플로우
**챌린지 인증 플로우**
   - 세션 검증 → D1에서 랜덤 질문 조회 → 사용자 답변 → D1 정답 검증 → 권한 부여

### 요구사항 3 : 시스템 관리자로서, 각 교재별로 챌린지 질문 데이터를 미리 준비하고 관리할 수 있어야 하며, 사용자의 인증 상태와 권한을 추적할 수 있어야 합니다.
#### 승인 기준
1. 시스템이 초기화되면 THEN D1 데이터베이스에 Users, Entitlements, ChallengeIndex 테이블이 생성되어야 합니다
2. ChallengeIndex 테이블에 데이터가 입력되면 각 레코드는 book_id, page, line, word_index, answer_word를 포함해야 합니다
3. 사용자가 로그인하면 시스템은 해당 사용자의 모든 권한을 조회할 수 있어야 합니다
4. 권한 검증이 필요하면 시스템은 사용자 세션과 Entitlements 테이블을 확인해야 합니다
5. 데이터베이스 작업이 실행되면 모든 외래 키 제약조건이 적용되어야 합니다

### 요구사항 4 : 플랫폼 사용자로서, 봇이나 악의적인 접근으로부터 보호받을 수 있어야 하며, 시스템의 모든 API 요청이 안전하게 처리되어야 합니다.
#### 승인 기준
1. 모든 API 요청이 수신되면 Cloudflare Turnstile 검증을 통과해야 합니다
2. OTP 요청이 과도하게 발생하면 시스템은 rate limiting을 적용해야 합니다
3. 챌린지 답변이 연속으로 틀리면 시스템은 일정 시간 동안 해당 사용자의 챌린지 시도를 제한해야 합니다
4. 세션이 만료되면 시스템은 자동으로 로그아웃 처리해야 합니다
5. API 오류가 발생하면 시스템은 적절한 HTTP 상태 코드와 오류 메시지를 반환해야 합니다




# 2단계 로그인 상태 확인(사용자가 QR Code를 통해 접속한 뒤)
## 1-1 로그인이 안되어 있으면 로그인 또는 회원가입 페이지로 리디렉션
## 1-2 회원가입 페이지에서는 이메일 주소와 OTP로 인증해서 가입 가능
## 1-3 로그인이 되어 있으면 시스템은 해당 교재에 대한 권한 확인
## 1-4 권한이 있으면 즉시 해설을 표시
## 1-5 권한이 없으면 도서 구매 인증 페이지로 리디렉션
## 1-6 도서 인증 페이지에서는 3개의 질문을 제시(그 중 2개 이상 맞으면 도서 인증 및 권한 제공), (질문은 10가지 정도로 구성할 예정, 지금은 임의로 예시 작성 부탁, 예를 들어 질문 : p. 16 왼쪽 문제의 1번 보기는? – 정답: 3)



# 3단계 수식 렌더링
## 해설의 모든 수학 공식은 KaTeX으로 빠르게 정확하게 렌더링 되어야 함




# 4단계 보안
## 모든 해설 콘텐츠에 사용자를 식별할 수 있는 워터마크가 삽입되어야 하며, 콘텐츠 복사나 무단 배포를 방지할 수 있는 보안 조치가 적용되어야 함
## 해설 콘텐츠가 사용자에게 전달되면 사용자의 이메일 해시가 포함된 워터마크가 동적으로 삽입
## 워터마크가 삽입되면 CSS pseudo-element를 사용하여 개발자 도구로 쉽게 제거할 수 없도록 구현
## 사용자가 콘텐츠에 접근하면 우클릭, 텍스트 선택, 복사 기능이 JavaScript로 차단
## 콘텐츠 페이지가 로드되면 개발자 도구 사용을 감지하고 경고 메시지를 표시
## 콘텐츠가 제공되면 적절한 보안 헤더(CSP, X-Frame-Options 등)가 설정
## 보안 고려사항
### 1. 워터마킹 보안
- 사용자 이메일 해시를 사용한 식별
- CSS pseudo-element로 제거 어려움 증대
- 다중 위치 워터마크 삽입
- 인쇄 시 워터마크 강화
### 2. 콘텐츠 보호
- 우클릭, 복사, 선택 차단
- 개발자 도구 감지 및 경고
- 키보드 단축키 차단
- 스크린샷 방지 (가능한 범위 내)
### 3. 네트워크 보안
- HTTPS 강제 사용
- 적절한 CSP 헤더 설정
- 레퍼러 정책 설정
- 봇 크롤링 방지
### 4. 접근 제어
- 세션 기반 인증 확인
- 권한별 콘텐츠 접근 제어
- Rate limiting 적용
- 의심스러운 활동 감지


# 5단계 UI/UX 개선 : 직관적이고 접근성이 뛰어난 인터페이스를 제공하여 사용자가 쉽게 인증하고 해설 콘텐츠를 이용할 수 있도록 합니다. Tailwind CSS와 shadcn/ui를 활용하여 현대적이고 반응형인 디자인을 구현하며, 다양한 디바이스와 접근성 요구사항을 충족합니다.

## 요구사항
### 요구사항 1 : 교재를 구매한 사용자로서, 처음 플랫폼에 접근할 때 명확하고 직관적인 안내를 받아야 하며, 복잡한 절차 없이 쉽게 계정을 생성하고 로그인할 수 있어야 합니다.
#### 승인 기준
1. 사용자가 플랫폼에 처음 접근하면 명확한 환영 메시지와 서비스 소개가 표시되어야 합니다
2. 로그인 페이지가 표시되면 이메일 입력 필드와 명확한 안내 텍스트가 제공되어야 합니다
3. 사용자가 이메일을 입력하면 실시간 유효성 검사와 피드백이 제공되어야 합니다
4. OTP 입력 페이지가 표시되면 6자리 숫자 입력 필드와 자동 포커스가 적용되어야 합니다
5. 인증 과정이 진행되면 각 단계별 진행 상황이 시각적으로 표시되어야 합니다

### 요구사항 2 : 교재 소유권을 증명해야 하는 사용자로서, 구매 인증 과정이 명확하게 안내되어야 하며, 실물 책을 참조하기 쉬운 형태로 질문이 제시되어야 합니다.
#### 승인 기준
1. 교재 구매 인증 페이지가 표시되면 교재 소유권 증명의 목적과 과정이 명확하게 설명되어야 합니다
2. 교재 구매 인증 질문이 표시되면 "X페이지, Y번째 줄, Z번째 단어" 형식으로 명확하게 제시되어야 합니다
3. 사용자가 답변을 입력하면 실시간 입력 검증과 자동완성 기능이 제공되어야 합니다
4. 교재 구매 인증 결과가 표시되면 정답/오답 여부와 최종 결과가 명확하게 표시되어야 합니다
5. 챌교재 구매 인증에 실패하면 재시도 방법과 제한 사항이 친절하게 안내되어야 합니다

### 요구사항 3 : 해설 콘텐츠를 이용하는 사용자로서, 수학 공식과 해설이 읽기 쉽게 표시되어야 하며, 학습 진도에 맞춰 단계별로 내용을 확인할 수 있어야 합니다.
#### 승인 기준
1. 해설 페이지가 로드되면 수학 공식이 KaTeX를 통해 정확하고 아름답게 렌더링되어야 합니다
2. 사용자가 해설을 읽으면 적절한 글꼴(serif/sanserif) 그리고 글자 크기와 줄 간격으로 가독성이 최적화되어야 합니다

### 요구사항 4 : 다양한 디바이스를 사용하는 사용자로서, 모바일, 태블릿, 데스크톱 환경에서 모두 최적화된 경험을 받아야 하며, 개인의 선호에 맞는 테마와 설정을 사용할 수 있어야 합니다.
#### 승인 기준
1. 모바일 디바이스에서 접근하면 터치 친화적인 인터페이스와 적절한 버튼 크기가 제공되어야 합니다
2. 태블릿에서 접근하면 화면 크기에 최적화된 레이아웃과 네비게이션이 제공되어야 합니다
3. 다크 모드를 선택하면 모든 UI 요소가 일관된 다크 테마로 표시되어야 합니다
4. 글꼴 크기를 조정하면 전체 인터페이스가 비례적으로 조정되어야 합니다
5. 사용자 설정을 변경하면 브라우저에 저장되어 다음 방문 시에도 유지되어야 합니다

### 요구사항 5 : 플랫폼을 효율적으로 사용하고 싶은 사용자로서, 빠른 로딩 시간과 부드러운 애니메이션을 경험해야 하며, 오류 상황에서도 명확한 안내를 받을 수 있어야 합니다.
#### 승인 기준
1. 페이지가 로드되면 초기 렌더링이 1초 이내에 완료되어야 합니다
2. 사용자 상호작용이 발생하면 100ms 이내에 시각적 피드백이 제공되어야 합니다
3. 페이지 전환이 발생하면 부드러운 트랜지션 애니메이션이 적용되어야 합니다
4. 네트워크 오류가 발생하면 사용자 친화적인 오류 메시지와 해결 방법이 제시되어야 합니다
5. 로딩이 지연되면 진행 상황을 나타내는 로딩 인디케이터가 표시되어야 합니다